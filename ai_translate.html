<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>SRT Editor - Gemini 3 Flash Preview</title>
    <style>
        :root { --bg-color: #ffffff; --line-num-bg: #f5f5f5; --line-num-text: #999; --border-color: #ddd; --font-size: 14px; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 15px; background: #f8f9fa; height: 100vh; display: flex; flex-direction: column; box-sizing: border-box; }
        .toolbar { margin-bottom: 12px; padding: 15px; background: #fff; border: 1px solid var(--border-color); border-radius: 8px; display: flex; gap: 12px; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .ai-status { background: #e8f0fe; padding: 8px 12px; border-radius: 5px; border: 1px solid #c2d7ff; color: #1967d2; font-weight: bold; font-size: 13px; }
        input[type="password"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 280px; }
        button { padding: 8px 18px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        button:hover { background: #174ea6; }
        .editor-container { display: flex; border: 1px solid var(--border-color); background: #fff; flex-grow: 1; overflow: hidden; border-radius: 6px; }
        .line-numbers { min-width: 45px; background: var(--line-num-bg); color: var(--line-num-text); text-align: right; padding: 10px 8px; font-family: 'Consolas', monospace; font-size: var(--font-size); border-right: 1px solid var(--border-color); user-select: none; white-space: pre; }
        textarea#editor { flex-grow: 1; border: none; padding: 10px; font-family: 'Consolas', monospace; font-size: var(--font-size); line-height: 22px; resize: none; outline: none; white-space: pre; overflow: scroll; }
        #progressOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); color: white; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; text-align: center; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top: 4px solid #fff; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="toolbar">
        <input type="file" id="fileInput" accept=".srt">
        <div class="ai-status">Gemini 3 Flash Preview</div>
        <input type="password" id="apiKey" placeholder="Dán Gemini API Key tại đây...">
        <button onclick="translateWithAI()">Dịch Tự Động (Việt)</button>
        <button onclick="downloadSRT()" style="background: #34a853; margin-left: auto;">Lưu File SRT</button>
    </div>

    <div class="editor-container">
        <div class="line-numbers" id="lineNumbers">1</div>
        <textarea id="editor" spellcheck="false" placeholder="Nhập Key -> Chọn file SRT -> Nhấn Dịch..."></textarea>
    </div>

    <div id="progressOverlay">
        <div class="spinner"></div>
        <h2 id="statusText">Đang khởi tạo Gemini 3 Flash...</h2>
        <p id="progressDetail" style="color: #4fc3f7; font-family: monospace;"></p>
        <div id="retryTimer" style="color: #ffeb3b; font-size: 20px; margin-top: 10px;"></div>
    </div>

    <script>
        const editor = document.getElementById('editor');
        const lineNumbers = document.getElementById('lineNumbers');
        let srtMetadata = [];

        editor.addEventListener('scroll', () => { lineNumbers.scrollTop = editor.scrollTop; });
        const updateLineNumbers = () => {
            const lines = editor.value.split('\n').length;
            lineNumbers.innerHTML = Array.from({length: lines}, (_, i) => i + 1).join('\n');
        };

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const blocks = e.target.result.replace(/\r\n/g, '\n').trim().split(/\n\n+/);
                srtMetadata = []; let display = [];
                blocks.forEach(block => {
                    const parts = block.split('\n');
                    if(parts.length >= 3) {
                        srtMetadata.push({ index: parts[0], time: parts[1] });
                        display.push(parts.slice(2).join(' <br> '));
                    }
                });
                editor.value = display.join('\n');
                updateLineNumbers();
            };
            reader.readAsText(e.target.files[0]);
        });

        async function translateWithAI() {
            const key = document.getElementById('apiKey').value.trim();
            const content = editor.value.trim();
            if(!key || !content) return alert("Vui lòng cung cấp đầy đủ API Key và File phụ đề!");

            const lines = content.split('\n');
            const overlay = document.getElementById('progressOverlay');
            const statusText = document.getElementById('statusText');
            const progressDetail = document.getElementById('progressDetail');
            const retryTimer = document.getElementById('retryTimer');
            
            overlay.style.display = 'flex';
            let translatedResults = [];
            const batchSize = 50; // Gemini 3 Flash có cửa sổ ngữ cảnh lớn, dịch 50 dòng/lần

            for (let i = 0; i < lines.length; ) {
                const batch = lines.slice(i, i + batchSize);
                const prompt = `Bạn là một biên dịch viên chuyên nghiệp. Dịch các câu sau sang tiếng Việt. 
Yêu cầu:
1. Mỗi dòng đầu vào tương ứng chính xác với 1 dòng đầu ra.
2. Giữ nguyên ký hiệu "<br>".
3. Không thêm bớt bất kỳ thông tin nào khác ngoài nội dung dịch.
Nội dung:\n${batch.join('\n')}`;

                try {
                    statusText.innerText = "Gemini 3 Flash đang dịch thuật...";
                    progressDetail.innerText = `Tiến độ: ${i+1} - ${Math.min(i + batchSize, lines.length)} / ${lines.length}`;
                    retryTimer.innerText = "";
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${key}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { temperature: 0.1 } // Thấp để đảm bảo dịch chuẩn xác
                        })
                    });

                    const data = await response.json();

                    if (data.error) {
                        if (data.error.code === 429) {
                            for (let s = 30; s > 0; s--) {
                                statusText.innerText = "Hạn mức API miễn phí đã hết...";
                                retryTimer.innerText = `Tự động thử lại sau ${s} giây`;
                                await new Promise(r => setTimeout(r, 1000));
                            }
                            continue; // Thử lại lượt này
                        }
                        throw new Error(data.error.message);
                    }

                    const resultText = data.candidates[0].content.parts[0].text.trim();
                    const translatedBatch = resultText.split('\n').filter(l => l.trim() !== "");
                    translatedResults.push(...translatedBatch);
                    
                    i += batchSize;
                    await new Promise(r => setTimeout(r, 1000)); // Nghỉ 1s giữa các lượt

                } catch (err) {
                    alert("Lỗi hệ thống: " + err.message);
                    overlay.style.display = 'none';
                    return;
                }
            }

            editor.value = translatedResults.slice(0, lines.length).join('\n');
            updateLineNumbers();
            overlay.style.display = 'none';
            alert("Chúc mừng! Gemini 3 Flash đã dịch xong 100% file.");
        }

        function downloadSRT() {
            const lines = editor.value.split('\n');
            let res = "";
            for (let i = 0; i < Math.min(lines.length, srtMetadata.length); i++) {
                res += `${srtMetadata[i].index}\n${srtMetadata[i].time}\n${lines[i].replace(/ <br> /g, '\n')}\n\n`;
            }
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([res], {type:'text/plain'}));
            a.download = "phude_da_dich_gemini3.srt"; a.click();
        }
    </script>
</body>
</html>