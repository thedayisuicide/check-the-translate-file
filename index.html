<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>SRT Translator Tool</title>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 900px;
    margin: auto;
}

textarea {
    width: 100%;
    height: 320px;
    font-size: 14px;
    line-height: 1.6;
    font-family: Consolas, monospace;
    white-space: pre;
}

button {
    margin-top: 10px;
    padding: 8px 16px;
    font-size: 14px;
}
</style>
</head>

<body>

<h2>Import & Translate SRT</h2>
<input type="file" id="fileInput" accept=".srt">

<h3>Nội dung thoại (index khóa tuyệt đối)</h3>

<textarea id="textOutput"
placeholder="1  Hello&#10;2  How are you?"></textarea>

<button onclick="exportSRT()">Export SRT đã dịch</button>

<script>
const textOutput = document.getElementById('textOutput');
let flatMap = [];
let internal = false;

/* ========= IMPORT ========= */
document.getElementById('fileInput').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => parseSRT(reader.result);
    reader.readAsText(file, 'UTF-8');
});

function parseSRT(content) {
    flatMap = [];
    let lines = [];
    let idx = 1;

    content.replace(/\r/g, '').split('\n\n').forEach(block => {
        const parts = block.split('\n');
        if (parts.length < 3) return;

        const timeline = parts[1];
        parts.slice(2).forEach(text => {
            flatMap.push({ timeline });
            lines.push(`${idx}  ${text}`);
            idx++;
        });
    });

    internal = true;
    textOutput.value = lines.join('\n');
    internal = false;
}

/* ========= UTILS ========= */
function getLineInfo(pos) {
    const before = textOutput.value.slice(0, pos);
    const lineIndex = before.split('\n').length - 1;
    const lineStart = before.lastIndexOf('\n') + 1;
    const line = textOutput.value.split('\n')[lineIndex] || '';
    const prefixMatch = line.match(/^(\d+\s+)/);
    const prefixLength = prefixMatch ? prefixMatch[1].length : 0;
    return { lineStart, prefixLength };
}

/* ========= CARET LOCK ========= */
function fixCaret() {
    const pos = textOutput.selectionStart;
    const { lineStart, prefixLength } = getLineInfo(pos);
    const minPos = lineStart + prefixLength;

    if (pos < minPos) {
        textOutput.selectionStart = textOutput.selectionEnd = minPos;
    }
}

textOutput.addEventListener('mousedown', () => {
    requestAnimationFrame(fixCaret);
});

textOutput.addEventListener('mouseup', fixCaret);
textOutput.addEventListener('keydown', e => {
    const pos = textOutput.selectionStart;
    const { lineStart, prefixLength } = getLineInfo(pos);
    const minPos = lineStart + prefixLength;

    // Backspace / Left / Home
    if (
        (e.key === 'Backspace' && pos <= minPos) ||
        (e.key === 'ArrowLeft' && pos <= minPos) ||
        (e.key === 'Home')
    ) {
        e.preventDefault();
        textOutput.selectionStart = textOutput.selectionEnd = minPos;
    }
});

textOutput.addEventListener('input', () => {
    if (internal) return;

    const lines = textOutput.value.split('\n');
    const fixed = lines.map((line, i) => {
        const content = line.replace(/^\s*\d+\s*/, '');
        return `${i + 1}  ${content}`;
    });

    internal = true;
    const caret = textOutput.selectionStart;
    textOutput.value = fixed.join('\n');
    textOutput.selectionStart = textOutput.selectionEnd = caret;
    internal = false;

    fixCaret();
});

/* ========= EXPORT ========= */
function exportSRT() {
    const lines = textOutput.value.split('\n');
    if (lines.length !== flatMap.length) {
        alert('Số dòng không khớp!');
        return;
    }

    let out = '';
    lines.forEach((line, i) => {
        const text = line.replace(/^\d+\s+/, '');
        out += (i + 1) + '\n';
        out += flatMap[i].timeline + '\n';
        out += text + '\n\n';
    });

    const blob = new Blob([out], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    Object.assign(document.createElement('a'), {
        href: url,
        download: 'translated.srt'
    }).click();
    URL.revokeObjectURL(url);
}
</script>

</body>
</html>
