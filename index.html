<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>SRT Translator Tool</title>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 900px;
    margin: auto;
}

textarea {
    width: 100%;
    height: 320px;
    font-size: 14px;
    line-height: 1.6;
    font-family: Consolas, monospace;
}

button {
    margin-top: 10px;
    padding: 8px 16px;
    font-size: 14px;
}
</style>
</head>

<body>

<h2>Import & Translate SRT</h2>

<input type="file" id="fileInput" accept=".srt">

<h3>Nội dung thoại (mỗi dòng có index riêng)</h3>

<textarea id="textOutput"
          placeholder="1  Hello&#10;2  How are you?"></textarea>

<button onclick="exportSRT()">Export SRT đã dịch</button>

<script>
let srtBlocks = [];
let flatMap = [];

// Import SRT
document.getElementById('fileInput').addEventListener('change', function () {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => parseSRT(reader.result);
    reader.readAsText(file, 'UTF-8');
});

function parseSRT(content) {
    srtBlocks = [];
    flatMap = [];

    const blocks = content.replace(/\r/g, '').split('\n\n');
    let outputLines = [];
    let lineIndex = 1;

    blocks.forEach(block => {
        const lines = block.split('\n');
        if (lines.length < 3) return;

        const timeline = lines[1];
        const texts = lines.slice(2);

        texts.forEach(text => {
            flatMap.push({ timeline });
            outputLines.push(`${lineIndex}  ${text}`);
            lineIndex++;
        });
    });

    document.getElementById('textOutput').value =
        outputLines.join('\n');
}

// Export SRT
function exportSRT() {
    const lines = document
        .getElementById('textOutput')
        .value
        .split('\n');

    if (lines.length !== flatMap.length) {
        alert('Số dòng không khớp!');
        return;
    }

    let result = '';
    let srtIndex = 1;

    lines.forEach((line, i) => {
        const text = line.replace(/^\s*\d+\s+/, '');

        result += srtIndex + '\n';
        result += flatMap[i].timeline + '\n';
        result += text + '\n\n';

        srtIndex++;
    });

    downloadFile(result, 'translated.srt');
}

function downloadFile(content, filename) {
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();

    URL.revokeObjectURL(url);
}
</script>

</body>
</html>
