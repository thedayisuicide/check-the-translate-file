<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>SRT Translator Tool</title>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 900px;
    margin: auto;
}

textarea {
    width: 100%;
    height: 320px;
    font-size: 14px;
    line-height: 1.6;
    font-family: Consolas, monospace;
    white-space: pre;
}

button {
    margin-top: 10px;
    padding: 8px 16px;
    font-size: 14px;
}
</style>
</head>

<body>

<h2>Import & Translate SRT</h2>

<input type="file" id="fileInput" accept=".srt">

<h3>Nội dung thoại (index KHÓA – chỉ dịch text)</h3>

<textarea id="textOutput"
          placeholder="1  Hello&#10;2  How are you?"></textarea>

<button onclick="exportSRT()">Export SRT đã dịch</button>

<script>
let flatMap = [];
let isInternalUpdate = false;

// ================= IMPORT =================
document.getElementById('fileInput').addEventListener('change', function () {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => parseSRT(reader.result);
    reader.readAsText(file, 'UTF-8');
});

function parseSRT(content) {
    flatMap = [];

    const blocks = content.replace(/\r/g, '').split('\n\n');
    let output = [];
    let idx = 1;

    blocks.forEach(block => {
        const lines = block.split('\n');
        if (lines.length < 3) return;

        const timeline = lines[1];
        const texts = lines.slice(2);

        texts.forEach(text => {
            flatMap.push({ timeline });
            output.push(`${idx}  ${text}`);
            idx++;
        });
    });

    isInternalUpdate = true;
    textOutput.value = output.join('\n');
    isInternalUpdate = false;
}

// ================= LOCK INDEX =================
const textOutput = document.getElementById('textOutput');

textOutput.addEventListener('input', () => {
    if (isInternalUpdate) return;

    const lines = textOutput.value.split('\n');
    let fixed = [];
    let changed = false;

    lines.forEach((line, i) => {
        const correctPrefix = `${i + 1}  `;
        const content = line.replace(/^\s*\d+\s*/, '');

        if (!line.startsWith(correctPrefix)) {
            changed = true;
            fixed.push(correctPrefix + content);
        } else {
            fixed.push(line);
        }
    });

    if (changed) {
        const pos = textOutput.selectionStart;
        isInternalUpdate = true;
        textOutput.value = fixed.join('\n');
        textOutput.selectionStart = textOutput.selectionEnd = pos;
        isInternalUpdate = false;
    }
});

// ================= EXPORT =================
function exportSRT() {
    const lines = textOutput.value.split('\n');

    if (lines.length !== flatMap.length) {
        alert('Số dòng không khớp!');
        return;
    }

    let result = '';
    let srtIndex = 1;

    lines.forEach((line, i) => {
        const text = line.replace(/^\s*\d+\s*/, '');

        result += srtIndex + '\n';
        result += flatMap[i].timeline + '\n';
        result += text + '\n\n';

        srtIndex++;
    });

    downloadFile(result, 'translated.srt');
}

// ================= DOWNLOAD =================
function downloadFile(content, filename) {
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();

    URL.revokeObjectURL(url);
}
</script>

</body>
</html>
