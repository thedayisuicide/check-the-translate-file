<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>SRT Translator Tool</title>

<style>
body {
    font-family: Arial, sans-serif;
    padding: 20px;
    max-width: 900px;
    margin: auto;
}

h2, h3 {
    margin-bottom: 6px;
}

.editor {
    display: flex;
    border: 1px solid #ccc;
    height: 300px;
    font-size: 14px;
    line-height: 1.5;
    font-family: Consolas, monospace;
}

.line-numbers {
    width: 50px;
    background: #f5f5f5;
    text-align: right;
    padding: 6px 6px 6px 0;
    color: #999;
    overflow: hidden;
    user-select: none;
}

textarea {
    flex: 1;
    border: none;
    resize: none;
    padding: 6px;
    outline: none;
    font-family: Consolas, monospace;
    line-height: 1.5;
}

button {
    margin-top: 10px;
    padding: 8px 16px;
    font-size: 14px;
}

#lineCount {
    margin-top: 6px;
    font-size: 13px;
    color: #555;
}
</style>
</head>

<body>

<h2>Import & Translate SRT</h2>

<input type="file" id="fileInput" accept=".srt">

<h3>Nội dung thoại (mỗi câu 1 dòng)</h3>

<div class="editor">
    <div id="lineNumbers" class="line-numbers">1</div>
    <textarea id="textOutput"
              placeholder="Nội dung thoại sẽ hiển thị ở đây..."
              oninput="updateLineNumbers()"
              onscroll="syncScroll()"></textarea>
</div>

<div id="lineCount">Số dòng: 0</div>

<button onclick="exportSRT()">Export SRT đã dịch</button>

<script>
let srtBlocks = [];
let dialogueMap = [];

function updateLineNumbers() {
    const textarea = document.getElementById('textOutput');
    const lineNumbers = document.getElementById('lineNumbers');

    const lines = textarea.value.length === 0
        ? 1
        : textarea.value.split('\n').length;

    let numbers = '';
    for (let i = 1; i <= lines; i++) {
        numbers += i + '\n';
    }

    lineNumbers.textContent = numbers;
    document.getElementById('lineCount').innerText =
        'Số dòng: ' + (textarea.value.length === 0 ? 0 : lines);
}

function syncScroll() {
    const textarea = document.getElementById('textOutput');
    document.getElementById('lineNumbers').scrollTop = textarea.scrollTop;
}

// Import SRT
document.getElementById('fileInput').addEventListener('change', function () {
    const file = this.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => parseSRT(reader.result);
    reader.readAsText(file, 'UTF-8');
});

function parseSRT(content) {
    srtBlocks = [];
    dialogueMap = [];

    const blocks = content.replace(/\r/g, '').split('\n\n');
    let dialogues = [];

    blocks.forEach(block => {
        const lines = block.split('\n');
        if (lines.length < 3) return;

        const index = lines[0];
        const timeline = lines[1];
        const texts = lines.slice(2);

        texts.forEach(text => {
            dialogueMap.push({ index, timeline });
            dialogues.push(text);
        });

        srtBlocks.push({ index, timeline, texts });
    });

    const textarea = document.getElementById('textOutput');
    textarea.value = dialogues.join('\n');
    updateLineNumbers();
}

// Export SRT
function exportSRT() {
    const translatedLines = document
        .getElementById('textOutput')
        .value
        .split('\n');

    if (translatedLines.length !== dialogueMap.length) {
        alert('Số dòng dịch không khớp với số dòng gốc!');
        return;
    }

    let result = '';
    let lineCursor = 0;

    srtBlocks.forEach(block => {
        result += block.index + '\n';
        result += block.timeline + '\n';

        block.texts.forEach(() => {
            result += translatedLines[lineCursor++] + '\n';
        });

        result += '\n';
    });

    downloadFile(result, 'translated.srt');
}

function downloadFile(content, filename) {
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);

    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();

    URL.revokeObjectURL(url);
}

// init
updateLineNumbers();
</script>

</body>
</html>
